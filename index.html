<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>股票持仓比例提醒</title>
    <style>
        /* 自定义样式 */
        .highlight {
            background-color: #ffcccc;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div id="app" class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4 text-center">股票持仓比例提醒</h1>
        <div class="bg-white p-6 rounded shadow-md">
            <form @submit.prevent="addOrUpdateStock">
                <div class="mb-4">
                    <label for="stockCode" class="block text-gray-700 font-bold mb-2">股票代码</label>
                    <input type="text" v-model="newStock.code" id="stockCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入股票代码">
                </div>
                <div class="mb-4">
                    <label for="stockName" class="block text-gray-700 font-bold mb-2">股票名称</label>
                    <input type="text" v-model="newStock.name" id="stockName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入股票名称">
                </div>
                <div class="mb-4">
                    <label for="quantity" class="block text-gray-700 font-bold mb-2">持仓数量</label>
                    <input type="number" v-model="newStock.quantity" id="quantity" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入持仓数量">
                </div>
                <div class="mb-4">
                    <label for="price" class="block text-gray-700 font-bold mb-2">持仓价格</label>
                    <input type="number" v-model="newStock.price" id="price" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入持仓价格" min="0" max="10000" step="0.001">
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    {{ editingIndex!== -1? '保存修改' : '添加股票' }}
                </button>
            </form>
        </div>
        <div class="mt-6 bg-white p-6 rounded shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">持仓列表</h2>
                <div class="space-x-2">
                    <button @click="updateStockPrices" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        更新行情
                    </button>
                    <button @click="exportData" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        导出数据
                    </button>
                    <button @click="importData" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        导入数据
                    </button>
                </div>
            </div>
            <table class="w-full table-auto">
                <thead>
                    <tr>
                        <th class="px-4 py-2">股票代码</th>
                        <th class="px-4 py-2">股票名称</th>
                        <th class="px-4 py-2">持仓数量</th>
                        <th class="px-4 py-2">持仓价格</th>
                        <th class="px-4 py-2">现价</th>
                        <th class="px-4 py-2">持仓价值</th>
                        <th class="px-4 py-2">持仓比例</th>
                        <th class="px-4 py-2">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(stock, index) in stocks" :key="index" :class="{ highlight: stock.percentage > 0.3 }">
                        <td class="border px-4 py-2">{{ stock.code }}</td>
                        <td class="border px-4 py-2">{{ stock.name }}</td>
                        <td class="border px-4 py-2">{{ stock.quantity }}</td>
                        <td class="border px-4 py-2">{{ stock.price }}</td>
                        <td class="border px-4 py-2">{{ stock.currentPrice }}</td>
                        <td class="border px-4 py-2">{{ stock.value }}</td>
                        <td class="border px-4 py-2">{{ (stock.percentage * 100).toFixed(2) }}%</td>
                        <td class="border px-4 py-2">
                            <button @click="editStock(index)" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">修改</button>
                            <button @click="buyStock(index)" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline ml-2">买入</button>
                            <button @click="sellStock(index)" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline ml-2">卖出</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    newStock: {
                        code: '',
                        name: '',
                        quantity: 0,
                        price: 0,
                        currentPrice: 0
                    },
                    stocks: JSON.parse(localStorage.getItem('stocks')) || [],
                    editingIndex: -1
                };
            },
            methods: {
                saveToLocalStorage() {
                    localStorage.setItem('stocks', JSON.stringify(this.stocks));
                },
                addOrUpdateStock() {
                    const { code, name, quantity, price, currentPrice } = this.newStock;
                    if (code && name && quantity > 0 && price >= 0.000 && price <= 10000.000) {
                        const value = quantity * price;
                        if (this.editingIndex !== -1) {
                            this.stocks[this.editingIndex] = {
                                code,
                                name,
                                quantity,
                                price,
                                currentPrice,
                                value
                            };
                            this.editingIndex = -1;
                        } else {
                            this.stocks.push({
                                code,
                                name,
                                quantity,
                                price,
                                currentPrice,
                                value
                            });
                        }
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                        this.newStock = {
                            code: '',
                            name: '',
                            quantity: 0,
                            price: 0,
                            currentPrice: 0
                        };
                    }
                },
                calculatePercentages() {
                    const totalValue = this.stocks.reduce((sum, stock) => sum + stock.value, 0);
                    this.stocks.forEach(stock => {
                        stock.percentage = stock.value / totalValue;
                    });
                },
                editStock(index) {
                    this.editingIndex = index;
                    const stock = this.stocks[index];
                    this.newStock = {
                        code: stock.code,
                        name: stock.name,
                        quantity: stock.quantity,
                        price: stock.price,
                        currentPrice: stock.currentPrice
                    };
                },
                buyStock(index) {
                    const stock = this.stocks[index];
                    const quantity = parseInt(prompt(`请输入要买入的${stock.name}数量：`));
                    if (quantity && quantity > 0) {
                        stock.quantity += quantity;
                        stock.value = stock.quantity * stock.price;
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                    }
                },
                sellStock(index) {
                    const stock = this.stocks[index];
                    const quantity = parseInt(prompt(`请输入要卖出的${stock.name}数量：`));
                    if (quantity && quantity > 0 && quantity <= stock.quantity) {
                        stock.quantity -= quantity;
                        stock.value = stock.quantity * stock.price;
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                    } else if (quantity > stock.quantity) {
                        alert('卖出数量不能大于持仓数量！');
                    }
                },
                exportData() {
                    const data = JSON.stringify(this.stocks, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stock_portfolio_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                importData() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    const importedData = JSON.parse(event.target.result);
                                    if (Array.isArray(importedData)) {
                                        this.stocks = importedData;
                                        this.calculatePercentages();
                                        this.saveToLocalStorage();
                                        alert('数据导入成功！');
                                    } else {
                                        alert('导入的数据格式不正确！');
                                    }
                                } catch (error) {
                                    alert('导入失败：文件格式错误！');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    input.click();
                },
                async updateStockPrices() {
                    try {
                        // 构建股票代码列表
                        const symbols = this.stocks.map(stock => stock.code).join(',');
                        console.log('请求的股票代码:', symbols);

                        const response = await fetch(`https://qt.gtimg.cn/q=${symbols}`);
                        
                        const text = await response.text();
                        console.log('返回的数据:', text);
                        
                        // 分割数据
                        const stockData = text.split('~');
                        console.log('分割后的数据:', stockData);
                        
                        // 输出每个字段的含义
                        const fields = [
                            '股票名称',
                            '乱码',
                            '股票代码',
                            '当前价格',
                            '昨收价',
                            '今开价',
                            '未知',
                            '未知',
                            '未知'
                        ];
                        
                        stockData.forEach((value, index) => {
                            if (index < fields.length) {
                                console.log(`${fields[index]}: ${value}`);
                            }
                        });

                        // 更新股票现价
                        const currentPrice = parseFloat(stockData[3]); // 当前价格在第4个位置
                        if (!isNaN(currentPrice)) {
                            const stock = this.stocks.find(s => s.code === symbols);
                            if (stock) {
                                stock.currentPrice = currentPrice;
                                stock.value = stock.quantity * currentPrice;
                                console.log(`更新${stock.name}现价为: ${currentPrice}`);
                            }
                        }

                        this.calculatePercentages();
                        this.saveToLocalStorage();
                        alert('股票数据更新完成！');
                    } catch (error) {
                        console.error('获取股票数据失败:', error);
                        alert('获取股票数据失败，请稍后重试！\n可能原因：\n1. 网络连接问题\n2. 股票代码格式不正确\n3. 服务器暂时不可用');
                    }
                },
                
                startAutoUpdate() {
                    // 每4小时更新一次数据
                    setInterval(() => {
                        this.updateStockPrices();
                    }, 14400000); // 4小时 = 4 * 60 * 60 * 1000毫秒
                }
            },
            mounted() {
                // 页面加载完成后自动更新一次数据
                this.updateStockPrices();
                // 启动自动更新
                this.startAutoUpdate();
            }
        }).mount('#app');
    </script>
</body>

</html>
    
