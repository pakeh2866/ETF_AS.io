<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>股票持仓比例提醒</title>
    <style>
        /* 自定义样式 */
        .highlight {
            background-color: #ffcccc;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div id="app" class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4 text-center">股票持仓比例提醒</h1>
        <div class="mt-6 bg-white p-6 rounded shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">持仓列表</h2>
                <div class="space-x-2">
                    <button @click="updateStockPrices" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        更新行情
                    </button>
                    <button @click="exportData" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        导出数据
                    </button>
                    <button @click="importData" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        导入数据
                    </button>
                </div>
            </div>
            <table class="w-full table-auto">
                <thead>
                    <tr>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('category')">
                            分类
                            <span v-if="sortKey === 'category'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('code')">
                            股票代码
                            <span v-if="sortKey === 'code'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('name')">
                            股票名称
                            <span v-if="sortKey === 'name'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('quantity')">
                            持仓数量
                            <span v-if="sortKey === 'quantity'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('price')">
                            持仓价格
                            <span v-if="sortKey === 'price'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('currentPrice')">
                            现价
                            <span v-if="sortKey === 'currentPrice'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('value')">
                            持仓价值
                            <span v-if="sortKey === 'value'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2 cursor-pointer select-none" @click="sortBy('percentage')">
                            持仓比例
                            <span v-if="sortKey === 'percentage'">
                                <span v-if="sortOrder === 'asc'">▲</span>
                                <span v-else-if="sortOrder === 'desc'">▼</span>
                                <span v-else>◇</span>
                            </span>
                            <span v-else>◇</span>
                        </th>
                        <th class="px-4 py-2">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(stock, index) in getSortedStocks()" :key="index" :class="{ highlight: stock.percentage > 0.2 }">
                        <td class="border px-4 py-2">{{ stock.category }}</td>
                        <td class="border px-4 py-2">{{ stock.code }}</td>
                        <td class="border px-4 py-2">{{ stock.name }}</td>
                        <td class="border px-4 py-2">{{ stock.quantity }}</td>
                        <td class="border px-4 py-2">{{ stock.price }}</td>
                        <td class="border px-4 py-2">{{ stock.currentPrice }}</td>
                        <td class="border px-4 py-2">{{ stock.value.toFixed(2) }} </td>
                        <td class="border px-4 py-2">{{ (stock.percentage * 100).toFixed(2) }}%</td>
                        <td class="border px-4 py-2">
                            <button @click="editStock(stock)" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">修改</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="bg-white p-6 rounded shadow-md">
            <form @submit.prevent="addOrUpdateStock">
                <div class="mb-4">
                    <label for="stockCategory" class="block text-gray-700 font-bold mb-2">分类</label>
                    <select v-model="newStock.category" id="stockCategory" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="A股">A股</option>
                        <option value="港股">港股</option>
                        <option value="其他海外">其他海外</option>
                        <option value="国内债">国内债</option>
                        <option value="黄金">黄金</option>
                        <option value="石油">石油</option>
                        <option value="现金">现金</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="stockCode" class="block text-gray-700 font-bold mb-2">股票代码</label>
                    <input type="text" v-model="newStock.code" id="stockCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入股票代码">
                </div>
                <div class="mb-4">
                    <label for="stockName" class="block text-gray-700 font-bold mb-2">股票名称</label>
                    <input type="text" v-model="newStock.name" id="stockName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入股票名称">
                </div>
                <div class="mb-4">
                    <label for="quantity" class="block text-gray-700 font-bold mb-2">持仓数量</label>
                    <input type="number" v-model="newStock.quantity" id="quantity" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入持仓数量">
                </div>
                <div class="mb-4">
                    <label for="price" class="block text-gray-700 font-bold mb-2">持仓价格</label>
                    <input type="number" v-model="newStock.price" id="price" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="输入持仓价格" min="0" max="10000" step="0.001">
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    {{ editingIndex!== -1? '保存修改' : '添加股票' }}
                </button>
            </form>
        </div>
        <div class="mb-6 bg-white p-6 rounded shadow-md flex flex-col items-center">
            <h2 class="text-xl font-bold mb-2">分类持仓比例</h2>
            <canvas id="categoryChart" width="150" height="150"></canvas>
        </div>
        <div class="mb-6 bg-white p-6 rounded shadow-md flex flex-col items-center">
            <h2 class="text-xl font-bold mb-2">品种持仓比例</h2>
            <canvas id="productChart" width="150" height="150"></canvas>
        </div>
    </div>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    newStock: {
                        code: '',
                        name: '',
                        quantity: 0,
                        price: 0,
                        currentPrice: 0,
                        category: 'A股'
                    },
                    stocks: JSON.parse(localStorage.getItem('stocks')) || [],
                    editingIndex: -1,
                    sortKey: '',
                    sortOrder: '',
                    categoryChart: null,
                };
            },
            methods: {
                saveToLocalStorage() {
                    localStorage.setItem('stocks', JSON.stringify(this.stocks));
                },
                addOrUpdateStock() {
                    const { code, name, quantity, price, currentPrice, category } = this.newStock;
                    if (name === '现金') {
                        currentPrice = 1;
                    }
                    if (code && name && quantity > 0 && price >= 0.000 && price <= 10000.000) {
                        const value = quantity * price;
                        if (this.editingIndex !== -1) {
                            this.stocks[this.editingIndex] = {
                                code,
                                name,
                                quantity,
                                price,
                                currentPrice,
                                value,
                                category
                            };
                            this.editingIndex = -1;
                        } else {
                            this.stocks.push({
                                code,
                                name,
                                quantity,
                                price,
                                currentPrice,
                                value,
                                category
                            });
                        }
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                        this.renderCategoryChart();
                        this.newStock = {
                            code: '',
                            name: '',
                            quantity: 0,
                            price: 0,
                            currentPrice: 0,
                            category: 'A股'
                        };
                    }
                },
                calculatePercentages() {
                    const totalValue = this.stocks.reduce((sum, stock) => sum + stock.value, 0);
                    this.stocks.forEach(stock => {
                        stock.percentage = stock.value / totalValue;
                    });
                },
                editStock(stock) {
                    this.editingIndex = this.stocks.indexOf(stock);
                    this.newStock = {
                        code: stock.code,
                        name: stock.name,
                        quantity: stock.quantity,
                        price: stock.price,
                        currentPrice: stock.currentPrice,
                        category: stock.category || 'A股'
                    };
                },
                buyStock(index) {
                    const stock = this.stocks[index];
                    const quantity = parseInt(prompt(`请输入要买入的${stock.name}数量：`));
                    if (quantity && quantity > 0) {
                        stock.quantity += quantity;
                        stock.value = stock.quantity * stock.price;
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                    }
                },
                sellStock(index) {
                    const stock = this.stocks[index];
                    const quantity = parseInt(prompt(`请输入要卖出的${stock.name}数量：`));
                    if (quantity && quantity > 0 && quantity <= stock.quantity) {
                        stock.quantity -= quantity;
                        stock.value = stock.quantity * stock.price;
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                    } else if (quantity >= stock.quantity) {
                        alert('卖出数量不能大于持仓数量！');
                    }
                },
                exportData() {
                    const data = JSON.stringify(this.stocks, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stock_portfolio_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                importData() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    const importedData = JSON.parse(event.target.result);
                                    if (Array.isArray(importedData)) {
                                        this.stocks = importedData;
                                        this.calculatePercentages();
                                        this.saveToLocalStorage();
                                        this.renderCategoryChart();
                                        alert('数据导入成功！');
                                    } else {
                                        alert('导入的数据格式不正确！');
                                    }
                                } catch (error) {
                                    alert('导入失败：文件格式错误！');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    input.click();
                },
                async updateStockPrices() {
                    try {
                        if (this.stocks.length === 0) {
                            console.log('持仓列表为空，无需更新行情。');
                            return;
                        }

                        // 直接使用您提供的包含前缀的股票代码
                        const querySymbols = this.stocks.map(stock => stock.code.trim()).join(',');

                        console.log('请求的腾讯接口代码:', querySymbols);

                        // 检查 querySymbols 是否为空，以防所有代码都是无效的或被过滤掉
                        if (!querySymbols) {
                             console.log('没有有效的股票代码可供查询。');
                             return;
                        }


                        const response = await fetch(`https://qt.gtimg.cn/q=${querySymbols}`);
                        console.log('请求的股票数据URL:', `https://qt.gtimg.cn/q=${querySymbols}`);
                        const text = await response.text();
                        console.log('返回的原始数据:', text);

                        // 按分号分割每个股票的数据
                        const individualStockData = text.trim().split(';').filter(s => s.length > 0);
                        console.log('分割后的单个股票数据:', individualStockData);

                        individualStockData.forEach(stockStr => {
                            // 提取股票代码 (例如 v_sh600000=...)
                            const stockCodeWithPrefixMatch = stockStr.match(/v_([a-z]{2}\d+)=/);
                            if (!stockCodeWithPrefixMatch) {
                                console.warn(`无法从 "${stockStr}" 中提取股票代码`);
                                return; // 跳过此条数据
                            }
                            const stockCodeWithPrefix = stockCodeWithPrefixMatch[1]; // 例如 sh600000

                            // 按波浪号分割字段
                            const fields = stockStr.split('~');
                            if (fields.length > 3) { // 确保有足够的数据字段
                                const currentPriceStr = fields[3]; // 当前价格字符串在第4个位置 (索引3)
                                const currentPrice = parseFloat(currentPriceStr);
                                const stockName = fields[1]; // 股票名称在第2个位置 (索引1)

                                console.log(`处理: ${stockCodeWithPrefix}, 名称: ${stockName}, 现价字符串: "${currentPriceStr}"`);

                                if (!isNaN(currentPrice) && currentPriceStr.trim() !== '') {
                                    // 使用包含前缀的代码进行匹配
                                    const stock = this.stocks.find(s => s.code === stockCodeWithPrefix);
                                    if (stock) {
                                        stock.currentPrice = currentPrice;
                                        stock.value = stock.quantity * currentPrice; // 使用现价计算价值
                                        console.log(`成功更新 ${stock.name} (${stockCodeWithPrefix}) 现价为: ${currentPrice}`);
                                    } else {
                                        console.warn(`未在持仓列表中找到代码为 ${stockCodeWithPrefix} 的股票`);
                                    }
                                } else {
                                    console.warn(`无法解析 ${stockName} (${stockCodeWithPrefix}) 的现价: "${currentPriceStr}"`);
                                }
                            } else {
                                console.warn(`数据格式不完整或字段不足: ${stockStr}`);
                            }
                        });

                        this.calculatePercentages(); // 重新计算比例
                        this.saveToLocalStorage();
                        this.renderCategoryChart();
                        alert('股票数据更新完成！');

                        // 保证现金现价为1
                        this.stocks.forEach(stock => {
                            if (stock.name === '现金') {
                                stock.currentPrice = 1;
                                stock.value = stock.quantity * 1;
                            }
                        });
                        this.calculatePercentages();
                        this.saveToLocalStorage();
                    } catch (error) {
                        console.error('获取股票数据失败:', error);
                        alert('获取股票数据失败，请稍后重试！\n可能原因：\n1. 网络连接问题\n2. 股票代码格式不正确\n3. 服务器暂时不可用');
                    }
                },
                
                startAutoUpdate() {
                    // 每4小时更新一次数据
                    setInterval(() => {
                        this.updateStockPrices();
                    }, 14400000); // 4小时 = 4 * 60 * 60 * 1000毫秒
                },
                sortBy(key) {
                    if (this.sortKey === key) {
                        if (this.sortOrder === '') {
                            this.sortOrder = 'asc';
                        } else if (this.sortOrder === 'asc') {
                            this.sortOrder = 'desc';
                        } else {
                            this.sortOrder = '';
                        }
                    } else {
                        this.sortKey = key;
                        this.sortOrder = 'asc';
                    }
                },
                getSortedStocks() {
                    if (!this.sortKey || this.sortOrder === '') {
                        return this.stocks;
                    }
                    return [...this.stocks].sort((a, b) => {
                        if (a[this.sortKey] === undefined || b[this.sortKey] === undefined) return 0;
                        if (typeof a[this.sortKey] === 'string') {
                            if (this.sortOrder === 'asc') {
                                return a[this.sortKey].localeCompare(b[this.sortKey]);
                            } else {
                                return b[this.sortKey].localeCompare(a[this.sortKey]);
                            }
                        } else {
                            if (this.sortOrder === 'asc') {
                                return a[this.sortKey] - b[this.sortKey];
                            } else {
                                return b[this.sortKey] - a[this.sortKey];
                            }
                        }
                    });
                },
                renderCategoryChart() {
                    const categoryMap = {};
                    const totalValue = this.stocks.reduce((sum, stock) => sum + stock.value, 0);
                    
                    // 计算每个分类的市值和比例
                    this.stocks.forEach(stock => {
                        if (!categoryMap[stock.category]) {
                            categoryMap[stock.category] = 0;
                        }
                        categoryMap[stock.category] += stock.value;
                    });
                    
                    const categories = Object.keys(categoryMap);
                    const values = Object.values(categoryMap);
                    const colors = [
                        '#4F46E5', '#22D3EE', '#F59E42', '#F43F5E', '#10B981', '#FBBF24', '#6366F1'
                    ];
                    
                    if (this.categoryChart) {
                        this.categoryChart.destroy();
                    }
                    
                    const ctx = document.getElementById('categoryChart').getContext('2d');
                    this.categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: categories,
                            datasets: [{
                                data: values,
                                backgroundColor: colors,
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const percentage = (context.raw / totalValue * 100).toFixed(2);
                                            return `${context.label}: ${percentage}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },
            },
            mounted() {
                this.updateStockPrices();
                this.startAutoUpdate();
                this.renderCategoryChart();
            }
        }).mount('#app');
    </script>
</body>

</html>
    
